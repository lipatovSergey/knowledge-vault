## 2025-08-25 — In-memory Mail Service (mock) for tests

**Feature goal:**  
Simulate email delivery during tests without external providers. Allow the app to “send” password-related emails and let tests inspect what was sent.

**Contract:**  
- Interface: `MailService` (JSdoc-typed)  
- Methods:
  - `sendPasswordReset(msg: MailMessage): Promise<void>`
  - `sendPasswordChanged(msg: MailMessage): Promise<void>`
  - `getSent(): MailMessage[]` (tests only)
  - `clear(): void` (tests only)
  - `lastTo(to: string): MailMessage | undefined` (tests only)
- Message type (`MailMessage` via JSDoc):
  - `to: string`, `subject: string`
  - optional: `text`, `html`, `meta: object`

### Development steps
1. **Define message type with JSDoc**  
   Introduced `@typedef {Object} MailMessage` with required and optional fields to document the payload shape used across the service.

2. **Define interface via base class**  
   Created `class MailService` with stub methods that `throw new Error("Not implemented")`.  
   Purpose: act as an interface so concrete implementations must override these methods.

3. **Add test helpers to the interface**  
   Exposed `getSent`, `clear`, and `lastTo` to let tests:  
   - read all sent messages (copy),  
   - reset the outbox,  
   - fetch the last message sent to a specific address.

4. **Implement in-memory mailer**  
   `InMemoryMailService` extends `MailService`, keeps `_outbox: MailMessage[]`, and pushes enriched records:
   - `sendPasswordReset` → `{ ...msg, type: "password reset", createdAt }`
   - `sendPasswordChanged` → `{ ...msg, type: "password-changed", createdAt }`
   - `getSent` → returns a shallow copy
   - `clear` → empties the outbox
   - `lastTo` → scans from the end and returns the latest match  
   Note: no logging in `_push` to avoid leaking sensitive data in test output.

5. **Provide a singleton instance**  
   Export a single shared instance (via Node’s module cache) so the same mailbox is used across the app/tests:
   ```js
   const InMemoryMailService = require("./in-memory-mail.service");
   const mail = new InMemoryMailService();
   module.exports = mail;
	```

Usage anywhere: `const mail = require("../services/mail");`

### Result
* Tests can assert email side effects without external services.
* Deterministic and fast: no network or third-party dependencies.
* Clear separation of concerns: the app depends on `MailService` interface; tests swap or inspect the in-memory implementation.

### Future work
* Add a real SMTP/Send provider implementation that also conforms to `MailService`.
* Provide a factory (config-driven) to choose between in-memory and real implementations.
* Optional: expose helpers for common assertions (e.g., `expectLastToContainToken(to)`).
