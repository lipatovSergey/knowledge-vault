# Knowledge Vault

Backend-проект для персонального управления знаниями на стеке MERN. Репозиторий демонстрирует производственные подходы к Express 5, сессионной аутентификации, безопасному восстановлению пароля и тестированию через Jest + Supertest.

---

## Кратко о продукте

- Node.js 18+, Express 5, MongoDB/Mongoose, Jest + Supertest.
- Многослойная архитектура (routes → controllers → services → repositories), которая разделяет HTTP, бизнес-логику и работу с БД.
- Сессионная аутентификация с безопасным восстановлением пароля: хэшированные токены, регенерация сессии, нейтральные ответы.
- При разработке я использовал TDD подход и опирался на лучшие практики [NODE.js Best Practices](https://github.com/goldbergyoni/nodebestpractices/tree/master)

---

## Ключевые возможности

- **Жизненный цикл пользователя**: регистрация, логин/логаут, профиль `me`, обновление имени, сессии с express-session.
- **Восстановление пароля**: селектор/валидатор, сохранённые токены в MongoDB, уничтожение после применения, тестовый почтовый ящик.
- **Домен знаний**: заметки с тегами и связями (сейчас реализовано создание; структура готова для расширения).
- **Инженерные практики**: централизованный error handler, логирование через Winston, санитизация тел запросов, graceful shutdown.

---

## Обзор архитектуры

### Валидация HTTP-запросов

- Валидация разделена на специализированные middleware по сегментам запроса: `validateBody`, `validateResetToken` и т.д. Каждое отвечает только за свою часть пайплайна.
- Каждое middleware пишет результат в отдельный канал (`req.validatedBody`, `req.validatedResetToken`, `req.validatedParams` и др.), что предотвращает конфликт данных и упрощает отладку.
- Контроллеры читают из соответствующего канала, а порядок подключения middleware в роутинге явно отражает цепочку подготовки данных.
- При добавлении новых источников входных данных создаём новый канал и middleware, а соглашение фиксируем в документации, чтобы команда всегда знала, где искать валидированную информацию.

```
HTTP запрос
    ↓
Routes (Express Router)
    ↓         ↘ middleware: сессии, валидация, auth-гарды
Controllers (принимают запрос, вызывают сервисы)
    ↓
Services (бизнес-правила, безопасность, оркестрация)
    ↓
Repositories (доступ к MongoDB через Mongoose)
    ↓
MongoDB
```

Кросс-срезовые утилиты (работа с сессией, крипто, логирование, валидация) остаются статeless и переиспользуемыми.

---

## Основные модули

- **Auth** (`src/components/auth`): логин/логаут, забытый пароль, регенерация сессий.
- **Users** (`src/components/users`): регистрация, профиль, хеширование пароля, валидация через Zod.
- **Notes** (`src/components/notes`): схема заметок и use-case создания, готовый фундамент для списка/фильтров/шеринга.

---

## Обзор API

| Область | Метод и путь                     | Назначение                                        | Доступ                  |
| ------- | -------------------------------- | ------------------------------------------------- | ----------------------- |
| Auth    | `POST /api/auth/login`           | Логин с регенерацией session ID                   | Только гость            |
|         | `POST /api/auth/logout`          | Завершение сессии и очистка cookie                | Аутентифицирован        |
|         | `POST /api/auth/password/forgot` | Нейтральный запуск восстановления пароля          | Публично                |
|         | `POST /api/auth/password/reset`  | Проверка токена, смена пароля, уничтожение сессии | Публично (по токену)    |
| Users   | `POST /api/users`                | Регистрация с валидаторами Zod                    | Публично                |
|         | `GET /api/users/me`              | Получение собственного профиля                    | Аутентифицирован        |
|         | `PATCH /api/users/me`            | Обновление имени                                  | Аутентифицирован        |
|         | `DELETE /api/users/me`           | Самостоятельное удаление аккаунта + logout        | Аутентифицирован        |
| Notes   | `POST /api/notes`                | Создание заметки (title/content/tags/links)       | Требует подключить auth |

Примеры запросов/ответов можно добавить при финальной полировке.

---

## Безопасность и защита данных

- **Сессии**: `express-session` + `connect-mongo`. Гарды `requireGuest`/`requireAuth`. `regenerateSession` предотвращает фиксацию, `destroySession` оборачивает callback API в промис.
- **Пароли**: `bcrypt` с настраиваемыми salt rounds. Проверки пароля вынесены в сервисы для единообразных ошибок.
- **Reset-токены**: пара selector/validator. Валидатор хранится в виде bcrypt-хэша, TTL-индексы чистят устаревшее, тайминг-атаки нивелируются «фальшивым» хэшем.
- **Валидация**: Zod-схемы, middleware складывает данные в `req.validatedData`.
- **Логирование**: Winston пишет в консоль (кроме тестов) и файлы, тела запросов обрезаются от секретов.

---

## Тестирование и качество

- **Jest + Supertest**: интеграционные сценарии для user/auth/password reset.
- **In-memory Mongo**: `mongodb-memory-server` обеспечивает скорость и детерминированность; хуки очищают коллекции между тестами.
- **Тестовый почтовый ящик**: имитация доставки писем для проверок без внешних зависимостей.
- **ESLint**: flat-конфиг + `eslint-plugin-n`; строгие правила для Node и CommonJS.
- **Devlog**: `docs/devlog/*` фиксирует TDD-циклы, дизайн-решения и компромиссы.

---

## Запуск локально

1. Установите Node.js ≥ 18.18 и MongoDB (или используйте облачный кластер/локальный инстанс).
2. `npm install`
3. Настройте переменные окружения (см. раздел «Конфигурация»).
4. `npm run dev` — запуск dev-сервера с nodemon.
5. `npm test` — Jest в режиме in-band с использованием in-memory Mongo.

---

## Конфигурация

Конфиг читается через пакет `config`: `config/default.json`, `config/test.json` + переменные окружения. Маппинг:

| Ключ конфигурации         | Переменная окружения | Назначение                                     |
| ------------------------- | -------------------- | ---------------------------------------------- |
| `port`                    | `PORT`               | HTTP-порт                                      |
| `db.uri`                  | `MONGO_URI`          | Строка подключения к MongoDB                   |
| `session_secret`          | `SESSION_SECRET`     | Секрет для подписи сессий                      |
| `node_env`                | `NODE_ENV`           | Режим (`development` / `production`)           |
| `frontend.url`            | `FRONTEND_URL`       | Базовый URL фронтенда для ссылок сброса пароля |
| `auth.reset_token_ttl_ms` | `RESET_TOKEN_TTL_MS` | Время жизни токена сброса пароля (мс)          |

---

## Логирование и наблюдаемость

- Форматированные логи с timestamp, уровнем и метаданными (без секретов).
- Запись в `logs/error.log` и `logs/combined.log`; в тестовом режиме консольный транспорт отключён.
- Error handler различает операционные `AppError` и неизвестные исключения, скрывает stack-trace в production.

---

## Структура проекта

```
Будет описана по завершению первой версии проекта
```

---

## Практики разработки

- **TDD**: каждая фича стартует с красного теста → минимальная реализация → рефакторинг.
- **Многослойность**: контроллеры тонкие, бизнес-правила в сервисах, доступ к БД в репозиториях.
- **Dependency injection**: сервисы получают репозитории и утилиты через параметры, что упрощает подмену/моки.
- **Документация**: README, devlog и TODO помогают отследить мотивацию решений и планы.

---

## Roadmap

1. Заменить хардкод `userId` в `note.controller` на данные из сессии (после подключения auth-мидлвари).
2. Расширить домен заметок: список, фильтры, совместное использование.
3. Подключить реальный почтовый транспорт (Nodemailer + SMTP/Ethereal) за интерфейсом `MailService`.
4. Добавить rate limiting (логин, восстановление пароля) и управление активными сессиями.
5. Добавить метрики запросов и аудит логов.

---

## Известные ограничения

- Notes-роут пока без auth-гарда и тестового покрытия — требуется доработка.
- Почтовая доставка реализована через in-memory стор — нужен реальный транспорт и шаблоны писем.
- Cookie `secure: false`; перед продом переключить на `true` и обеспечить HTTPS.
- Пока нет Docker/CI — планируется для production-ready поставки.

---

## Дополнительные материалы

- **Devlog**: `docs/devlog/*` — дневники TDD (например, фича восстановления пароля от 2025-08-25).
